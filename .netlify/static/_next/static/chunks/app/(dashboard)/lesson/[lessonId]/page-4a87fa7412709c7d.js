(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[918],{8196:function(e,s,t){Promise.resolve().then(t.bind(t,7997))},2615:function(e,s,t){"use strict";t.d(s,{Z:function(){return l}});/**
 * @license lucide-react v0.323.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=(0,t(140).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},2055:function(e,s,t){"use strict";t.d(s,{Z:function(){return l}});/**
 * @license lucide-react v0.323.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=(0,t(140).Z)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]])},3629:function(e,s,t){"use strict";t.d(s,{default:function(){return a.a}});var l=t(5511),a=t.n(l)},7997:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return _}});var l=t(789),a=t(8207),r=t(4505),n=t(8520),i=t(4930),c=t(5425),o=t(3869);let d=(0,c.Ue)((e,s)=>({user:null,isLoading:!0,currentLevel:1,levelProgress:0,nextLevelXP:100,setUser:s=>{if(!s){e({user:null,isLoading:!1,currentLevel:1,levelProgress:0,nextLevelXP:100});return}let t=(0,o.IN)(s.xp);e({user:s,isLoading:!1,currentLevel:t.level,levelProgress:t.progress,nextLevelXP:t.nextLevelXP})},addXP:t=>{let{user:l}=s();if(!l)return;let a=l.xp+t,r={...l,xp:a},n=(0,o.IN)(a);e({user:r,currentLevel:n.level,levelProgress:n.progress,nextLevelXP:n.nextLevelXP}),n.level>l.level&&s().updateLevel()},addCoins:t=>{let{user:l}=s();if(!l)return;let a=l.coins+t;e({user:{...l,coins:a}})},updateLevel:()=>{let{user:t,currentLevel:l}=s();t&&l!==t.level&&e({user:{...t,level:l}})},reset:()=>{e({user:null,isLoading:!1,currentLevel:1,levelProgress:0,nextLevelXP:100})}}));var u=t(2821),h=t(4710),p=t(9986),x=t(8713),m=t(2615);/**
 * @license lucide-react v0.323.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let v=(0,t(140).Z)("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);var f=t(8060),g=t(2055),j=t(3629);function _(){let e=(0,r.useParams)(),s=(0,r.useRouter)(),{profile:t}=(0,n.a)(),{toast:c}=(0,x.pm)(),o=d(e=>e.updateXP),_=d(e=>e.updateCoins),w=e.lessonId,[N,S]=(0,a.useState)(null),[b,y]=(0,a.useState)(null),[T,P]=(0,a.useState)(!0),[L,O]=(0,a.useState)(!1),[E,k]=(0,a.useState)(!1),[A,I]=(0,a.useState)(0),[D,C]=(0,a.useState)(""),[z,M]=(0,a.useState)(""),[X,Z]=(0,a.useState)("");(0,a.useEffect)(()=>{t&&w&&q()},[t,w]);let q=async()=>{var e,l,a,r,n,c;let o=(0,i.e)(),{data:d}=await o.from("lessons").select("*, courses(*)").eq("id",w).single();if(!d){s.push("/learn");return}S(d),y(d.courses);let u=d.content;if(C((null===(e=u.starter_code)||void 0===e?void 0:e.html)||""),M((null===(l=u.starter_code)||void 0===l?void 0:l.css)||""),Z((null===(a=u.starter_code)||void 0===a?void 0:a.js)||""),t){let{data:e}=await o.from("user_progress").select("code_snapshot").eq("user_id",t.id).eq("lesson_id",w).single();if(null==e?void 0:e.code_snapshot){let s=e.code_snapshot;C(s.html||(null===(r=u.starter_code)||void 0===r?void 0:r.html)||""),M(s.css||(null===(n=u.starter_code)||void 0===n?void 0:n.css)||""),Z(s.js||(null===(c=u.starter_code)||void 0===c?void 0:c.js)||"")}}P(!1)},R=async()=>{if(!t)return;let e=(0,i.e)(),{error:s}=await e.from("user_progress").upsert({user_id:t.id,lesson_id:w,status:"in_progress",code_snapshot:{html:D,css:z,js:X},updated_at:new Date().toISOString()});s?c({title:"保存失败",description:s.message,variant:"destructive"}):c({title:"保存成功",description:"你的进度已保存"})},F=async()=>{if(t&&N){O(!0);try{let e=await fetch("/api/ai/grade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:D,css:z,js:X,instructions:N.content.instructions,validationRules:N.content.validation_rules})}),l=await e.json();if(l.score>=60){let e=(0,i.e)();await e.from("user_progress").upsert({user_id:t.id,lesson_id:w,status:"completed",score:l.score,code_snapshot:{html:D,css:z,js:X},completed_at:new Date().toISOString(),updated_at:new Date().toISOString()});let a=t.xp+N.xp_reward,r=t.coins+N.coin_reward;await e.from("users").update({xp:a,coins:r}).eq("id",t.id),o(a),_(r),c({title:"\uD83C\uDF89 恭喜通过!",description:"获得 ".concat(N.xp_reward," XP 和 ").concat(N.coin_reward," 金币!")}),setTimeout(()=>{s.push("/learn/".concat(b.id))},2e3)}else c({title:"还需要改进",description:l.feedback||"再试一次吧!",variant:"destructive"})}catch(e){c({title:"提交失败",description:"请稍后重试",variant:"destructive"})}finally{O(!1)}}},U=()=>{k(!0);let e=N.content;e.hints&&A<e.hints.length-1&&I(A+1)};if(T||!N)return(0,l.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,l.jsx)("div",{className:"loading-spinner"})});let H=N.content;return(0,l.jsxs)("div",{className:"flex h-screen flex-col bg-gray-50",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between border-b bg-white px-6 py-3 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsx)(j.default,{href:"/learn/".concat(b.id),children:(0,l.jsxs)(p.z,{variant:"ghost",size:"sm",className:"gap-2",children:[(0,l.jsx)(m.Z,{className:"h-4 w-4"}),"返回课程"]})}),(0,l.jsx)("div",{className:"h-6 w-px bg-gray-300"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"font-semibold text-gray-900",children:N.title}),(0,l.jsx)("p",{className:"text-xs text-gray-600",children:b.title})]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)(p.z,{variant:"outline",size:"sm",onClick:U,className:"gap-2",children:[(0,l.jsx)(v,{className:"h-4 w-4"}),"提示"]}),(0,l.jsxs)(p.z,{variant:"outline",size:"sm",onClick:R,className:"gap-2",children:[(0,l.jsx)(f.Z,{className:"h-4 w-4"}),"保存"]}),(0,l.jsx)(p.z,{size:"sm",onClick:F,disabled:L,className:"gap-2",children:L?(0,l.jsx)(l.Fragment,{children:"提交中..."}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(g.Z,{className:"h-4 w-4"}),"提交"]})})]})]}),(0,l.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,l.jsxs)("div",{className:"w-80 overflow-y-auto border-r bg-white p-6",children:[(0,l.jsx)("h3",{className:"mb-3 text-lg font-semibold text-gray-900",children:"任务说明"}),(0,l.jsx)("div",{className:"prose prose-sm mb-6 text-gray-700 whitespace-pre-wrap",children:H.instructions}),E&&H.hints&&(0,l.jsxs)("div",{className:"rounded-lg border border-yellow-200 bg-yellow-50 p-4",children:[(0,l.jsxs)("div",{className:"mb-2 flex items-center gap-2 text-yellow-800",children:[(0,l.jsx)(v,{className:"h-4 w-4"}),(0,l.jsx)("span",{className:"font-semibold",children:"提示"})]}),(0,l.jsx)("ul",{className:"space-y-2 text-sm text-yellow-900",children:H.hints.slice(0,A+1).map((e,s)=>(0,l.jsx)("li",{children:e},s))}),A<H.hints.length-1&&(0,l.jsx)(p.z,{variant:"link",size:"sm",onClick:U,className:"mt-2 px-0 text-yellow-700",children:"查看下一个提示 →"})]}),(0,l.jsxs)("div",{className:"mt-6 rounded-lg border border-blue-200 bg-blue-50 p-4",children:[(0,l.jsx)("h4",{className:"mb-2 font-semibold text-blue-900",children:"完成奖励"}),(0,l.jsxs)("div",{className:"space-y-1 text-sm text-blue-800",children:[(0,l.jsxs)("div",{children:["⚡ +",N.xp_reward," XP"]}),(0,l.jsxs)("div",{children:["\uD83E\uDE99 +",N.coin_reward," 金币"]})]})]})]}),(0,l.jsx)("div",{className:"flex flex-1 flex-col",children:(0,l.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,l.jsx)("div",{className:"flex-1",children:(0,l.jsx)(u.p,{html:D,css:z,js:X,onHtmlChange:C,onCssChange:M,onJsChange:Z})}),(0,l.jsx)("div",{className:"w-1/2 border-l",children:(0,l.jsx)(h.T,{html:D,css:z,js:X})})]})})]})]})}},8713:function(e,s,t){"use strict";t.d(s,{pm:function(){return h}});var l=t(8207);let a=0,r=new Map,n=e=>{if(r.has(e))return;let s=setTimeout(()=>{r.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,s)},i=(e,s)=>{switch(s.type){case"ADD_TOAST":return{...e,toasts:[s.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===s.toast.id?{...e,...s.toast}:e)};case"DISMISS_TOAST":{let{toastId:t}=s;return t?n(t):e.toasts.forEach(e=>{n(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===t||void 0===t?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===s.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==s.toastId)}}},c=[],o={toasts:[]};function d(e){o=i(o,e),c.forEach(e=>{e(o)})}function u(e){let{...s}=e,t=(a=(a+1)%Number.MAX_SAFE_INTEGER).toString(),l=()=>d({type:"DISMISS_TOAST",toastId:t});return d({type:"ADD_TOAST",toast:{...s,id:t,open:!0,onOpenChange:e=>{e||l()}}}),{id:t,dismiss:l,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function h(){let[e,s]=l.useState(o);return l.useEffect(()=>(c.push(s),()=>{let e=c.indexOf(s);e>-1&&c.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}}},function(e){e.O(0,[359,519,511,439,520,710,211,395,744],function(){return e(e.s=8196)}),_N_E=e.O()}]);