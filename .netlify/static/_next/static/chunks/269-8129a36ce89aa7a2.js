"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[269],{7269:function(t,e,a){a.d(e,{a:function(){return u}});var r=a(4090),i=a(7907),n=a(1097),s=a(94);function u(){let t=(0,i.useRouter)(),e=(0,n.e)(),[a,u]=(0,r.useState)({user:null,profile:null,loading:!0,isGuest:!1,isTrialValid:!1,trialDaysRemaining:0}),o=async()=>{try{let{data:{user:t}}=await e.auth.getUser();if(!t){try{let t=await (0,s._A)(),{data:{user:a}}=await e.auth.getUser();u({user:a,profile:t,loading:!1,isGuest:!0,isTrialValid:!0,trialDaysRemaining:(0,s.sG)(t.trial_expires_at)})}catch(t){console.error("创建游客账号失败:",t),u(t=>({...t,loading:!1}))}return}let{data:a,error:r}=await e.from("users").select("*").eq("id",t.id).single();if(r){console.error("获取用户profile失败:",r),u({user:t,profile:null,loading:!1,isGuest:t.is_anonymous||!1,isTrialValid:!1,trialDaysRemaining:0});return}let i="guest"===a.role||t.is_anonymous,n=(0,s.PW)(a.trial_started_at,a.trial_expires_at),o=(0,s.sG)(a.trial_expires_at);u({user:t,profile:a,loading:!1,isGuest:i,isTrialValid:n,trialDaysRemaining:o})}catch(t){console.error("加载用户失败:",t),u(t=>({...t,loading:!1}))}};(0,r.useEffect)(()=>{o();let{data:{subscription:t}}=e.auth.onAuthStateChange((t,e)=>{o()});return()=>{t.unsubscribe()}},[]);let l=async(t,a)=>{let{data:r,error:i}=await e.auth.signInWithPassword({email:t,password:a});if(i)throw i;return await o(),r},c=async(t,a,r,i)=>{let{data:n,error:s}=await e.auth.signUp({email:t,password:a,options:{data:{username:r,display_name:i,role:"student"}}});if(s)throw s;return await o(),n},d=async(t,a)=>{let{data:r,error:i}=await e.auth.signInWithOAuth({provider:t,options:{redirectTo:a||"".concat(window.location.origin,"/auth/callback")}});if(i)throw i;return r},f=async()=>{let{error:a}=await e.auth.signOut();if(a)throw a;u({user:null,profile:null,loading:!1,isGuest:!1,isTrialValid:!1,trialDaysRemaining:0}),t.push("/")},w=async t=>{if(!a.user)throw Error("未登录");let{data:r,error:i}=await e.from("users").update(t).eq("id",a.user.id).select().single();if(i)throw i;return u(t=>({...t,profile:r})),r},g=async()=>{await o()};return{...a,signInWithEmail:l,signUpWithEmail:c,signInWithOAuth:d,signOut:f,updateProfile:w,refreshUser:g}}},94:function(t,e,a){a.d(e,{_A:function(){return s},sG:function(){return n},be:function(){return o},PW:function(){return i},Xd:function(){return u}});var r=a(1097);function i(t,e){return!!t&&!!e&&new Date<new Date(e)}function n(t){if(!t)return 0;let e=new Date;return Math.max(0,Math.ceil((new Date(t).getTime()-e.getTime())/864e5))}async function s(){let t=(0,r.e)(),{data:e,error:a}=await t.auth.signInAnonymously();if(a||!e.user)throw Error("创建游客账号失败: ".concat(null==a?void 0:a.message));let i=e.user.id,n=new Date,s=new Date;s.setDate(s.getDate()+30);let{data:u,error:o}=await t.from("users").upsert({id:i,username:"guest_".concat(i.slice(0,8)),display_name:"游客",role:"guest",level:1,xp:0,coins:0,trial_started_at:n.toISOString(),trial_expires_at:s.toISOString()},{onConflict:"id"}).select().single();if(o)throw Error("创建用户记录失败: ".concat(o.message));return localStorage.setItem("guest_user_id",i),localStorage.setItem("trial_started_at",n.toISOString()),u}function u(t){return[7,3,1,0].includes(t)}function o(t){return 0===t?"您的试用期今天到期,请注册账号以继续学习。":1===t?"您的试用期还剩1天,立即注册可保留所有学习进度!":t<=3?"您的试用期还剩".concat(t,"天,注册账号可永久保存学习数据。"):t<=7?"您的试用期还剩".concat(t,"天,建议尽快注册以保留学习进度。"):""}},1097:function(t,e,a){a.d(e,{e:function(){return i}});var r=a(8102);function i(){try{let t="https://zzyueuweeoakopuuwfau.supabase.co",e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6eXVldXdlZW9ha29wdXV3ZmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzODEzMDEsImV4cCI6MjA1OTk1NzMwMX0.y8V3EXK9QVd3txSWdE3gZrSs96Ao0nvpnd0ntZw_dQ4";if(!t||!e)throw Error("Supabase配置缺失");return(0,r.AY)(t,e)}catch(t){throw console.error("Supabase客户端初始化失败:",t),t}}}}]);