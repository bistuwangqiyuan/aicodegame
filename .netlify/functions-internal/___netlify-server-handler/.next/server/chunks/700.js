"use strict";exports.id=700,exports.ids=[700],exports.modules={6700:(t,e,i)=>{i.d(e,{a:()=>u});var a=i(3729),r=i(8428),n=i(3890),s=i(6797);function u(){let t=(0,r.useRouter)(),e=(0,n.e)(),[i,u]=(0,a.useState)({user:null,profile:null,loading:!0,isGuest:!1,isTrialValid:!1,trialDaysRemaining:0}),l=async()=>{try{let{data:{user:t}}=await e.auth.getUser();if(!t){u(t=>({...t,loading:!1}));return}let{data:i,error:a}=await e.from("users").select("*").eq("id",t.id).single();if(a){console.error("获取用户profile失败:",a),u({user:t,profile:null,loading:!1,isGuest:t.is_anonymous||!1,isTrialValid:!1,trialDaysRemaining:0});return}let r="guest"===i.role||t.is_anonymous,n=(0,s.PW)(i.trial_started_at,i.trial_expires_at),l=(0,s.sG)(i.trial_expires_at);u({user:t,profile:i,loading:!1,isGuest:r,isTrialValid:n,trialDaysRemaining:l})}catch(t){console.error("加载用户失败:",t),u(t=>({...t,loading:!1}))}};(0,a.useEffect)(()=>{l();let{data:{subscription:t}}=e.auth.onAuthStateChange((t,e)=>{l()});return()=>{t.unsubscribe()}},[]);let o=async(t,i)=>{let{data:a,error:r}=await e.auth.signInWithPassword({email:t,password:i});if(r)throw r;return await l(),a},d=async(t,i,a,r)=>{let{data:n,error:s}=await e.auth.signUp({email:t,password:i,options:{data:{username:a,display_name:r,role:"student"}}});if(s)throw s;return await l(),n},c=async(t,i)=>{let{data:a,error:r}=await e.auth.signInWithOAuth({provider:t,options:{redirectTo:i||`${window.location.origin}/auth/callback`}});if(r)throw r;return a},w=async()=>{let{error:i}=await e.auth.signOut();if(i)throw i;u({user:null,profile:null,loading:!1,isGuest:!1,isTrialValid:!1,trialDaysRemaining:0}),t.push("/")},h=async t=>{if(!i.user)throw Error("未登录");let{data:a,error:r}=await e.from("users").update(t).eq("id",i.user.id).select().single();if(r)throw r;return u(t=>({...t,profile:a})),a},f=async()=>{await l()};return{...i,signInWithEmail:o,signUpWithEmail:d,signInWithOAuth:c,signOut:w,updateProfile:h,refreshUser:f}}},6797:(t,e,i)=>{function a(t,e){return!!t&&!!e&&new Date<new Date(e)}function r(t){if(!t)return 0;let e=new Date;return Math.max(0,Math.ceil((new Date(t).getTime()-e.getTime())/864e5))}function n(t){return[7,3,1,0].includes(t)}function s(t){return 0===t?"您的试用期今天到期,请注册账号以继续学习。":1===t?"您的试用期还剩1天,立即注册可保留所有学习进度!":t<=3?`您的试用期还剩${t}天,注册账号可永久保存学习数据。`:t<=7?`您的试用期还剩${t}天,建议尽快注册以保留学习进度。`:""}i.d(e,{sG:()=>r,be:()=>s,PW:()=>a,Xd:()=>n}),i(3890)},3890:(t,e,i)=>{i.d(e,{e:()=>r});var a=i(7569);function r(){try{let t="https://zzyueuweeoakopuuwfau.supabase.co",e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6eXVldXdlZW9ha29wdXV3ZmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzODEzMDEsImV4cCI6MjA1OTk1NzMwMX0.y8V3EXK9QVd3txSWdE3gZrSs96Ao0nvpnd0ntZw_dQ4";if(!t||!e)throw Error("Supabase配置缺失");return(0,a.AY)(t,e)}catch(t){throw console.error("Supabase客户端初始化失败:",t),t}}}};